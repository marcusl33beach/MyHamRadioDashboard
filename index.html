<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>MyHamDashboard</title>
    <style>
        /* GLOBAL RESET */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        #page-container { display:flex; flex-direction:column; min-height:100vh; }

        /* GRID LAYOUT (4x3) */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            gap: 6px;
            padding: 6px;
            box-sizing: border-box;
            width: 100%;
            height: calc(100vh - 34px); 
            overflow: hidden;
        }

        .grid-item { position: relative; background:#000; border:1px solid rgba(255,255,255,0.08); overflow:hidden; min-height:0; cursor: pointer; }
        .image-container { width:100%; height:100%; display:block; min-height:0 }
        .grid-item img, .grid-item video { width:100%; height:100%; object-fit:cover; display:block }
        .grid-item img.contain-fit { object-fit:contain; background:#000 }

        .image-title { position:absolute; top:0; left:0; width:100%; background:rgba(0,0,0,0.5); padding:6px 10px; font-weight:700; z-index:2 }
        .link-placeholder { display:flex; align-items:center; justify-content:center; width:100%; height:100%; color:#ddd; background:linear-gradient(180deg,#111,#000); font-weight:700 }

        /* TICKER */
        #ticker-wrap { position:fixed; left:0; right:0; bottom:0; height:34px; background:rgba(0,0,0,0.8); border-top:1px solid #444; display:flex; align-items:center; z-index:9999 }
        #ticker-title { padding:0 12px; background:rgba(0,0,0,0.7); color:#fff; height:34px; line-height:34px; display:flex; align-items:center; border-right:1px solid #444; position:relative; flex:0 0 auto; cursor: default; }
        
        .dropdown-content { display:none; position:absolute; bottom:34px; left:0; background-color:rgba(0,0,0,0.95); min-width:200px; box-shadow:0px -4px 16px rgba(0,0,0,0.5); border:1px solid #444; border-bottom:none; z-index:10000 }
        .dropdown-content a { color:#f0f0f0; padding:8px 12px; display:block; text-decoration:none; font-size:0.9em }
        .dropdown-content a:hover { background:rgb(78, 77, 77) }
        #ticker-title:hover .dropdown-content { display:block }

        #ticker-move { flex:1 1 auto; overflow:hidden; height:100%; display:flex; align-items:center }
        #ticker-inner { display:inline-block; min-width:100%; padding-left:100%; white-space:nowrap; animation:scroll-left 60s linear infinite; color:#fff; }
        @keyframes scroll-left { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }

        /* LIGHTBOX & SETTINGS */
        #lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:10000; }
        #lightbox-settings {
            display:none; 
            max-width:1100px; 
            width: 90%; 
            max-height:85vh; 
            overflow:auto; 
            padding:30px; 
            background:rgba(20, 20, 20, 0.98); border: 1px solid #555; border-radius:8px; 
            color:#eee; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .lightbox-content-style { max-width:95%; max-height:95%; }

        /* CAMERA GRID LIGHTBOX */
        #lightbox-cam-grid { 
            display:none; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 15px; 
            width: 90%; 
            max-height: 85vh; 
            overflow-y: auto; 
            padding: 10px;
        }
        .cam-grid-item { background: #000; border: 1px solid #444; position: relative; }
        .cam-grid-item img { width: 100%; height: auto; display: block; }

        #lightbox-close { position:absolute; top:18px; right:22px; font-size:34px; color:#fff; cursor:pointer; z-index: 10001; }
        
        .settings-row { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        input[type="number"], input[type="text"], textarea { background: #333; color: #fff; border: 1px solid #555; padding: 6px; border-radius: 4px; }
        button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: 1px solid #666; background: #444; color: #fff; }
        button:hover { background: #555; }
        h3 { border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 25px; }
        .btn-del { background: #822; border: none; padding: 4px 8px; }
    </style>
</head>
<body>

    <div style="position: absolute; top: 10px; right: 10px; z-index: 9999;">
        <button onclick="logout()" title="Logout" style="background:none; border:none; color:#888; cursor:pointer; font-size:24px; transition: color 0.3s;" onmouseover="this.style.color='#c0392b'" onmouseout="this.style.color='#888'">
            ‚èª
        </button>
    </div>

    <div id="page-container">
        <main id="grid-container"></main>
        <div id="ticker-wrap">
            <div id="ticker-title">‚ñæ Menu
                <div class="dropdown-content" id="dropdown-content"></div>
            </div>
            <div id="ticker-move"><div id="ticker-inner">Loading Weather & RSS...</div></div>
        </div>
    </div>

    <div id="lightbox" onclick="if(event.target.id==='lightbox') closeLightbox()">
        <div id="lightbox-close" onclick="closeLightbox()">&times;</div>
        <img id="lightbox-img" class="lightbox-content-style" style="display:none" />
        <video id="lightbox-video" class="lightbox-content-style" style="display:none" controls autoplay loop></video>
        <div id="lightbox-cam-grid" class="lightbox-content-style"></div>
        <div id="lightbox-settings" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        let LATITUDE = 38.98;
        let LONGITUDE = -84.77;
        let alertsText = '';
        let rssUrls = ["https://feeds.feedburner.com/weather/headlines"];
        let cameraRotationIntervals = [];

        let cameraRotations = [
            {
                tileIndex: 8,
                urls: [
                    'https://itscameras.dot.state.oh.us/images/artimis/CCTV_I-71-Gilbert.jpg?date=1766935079000',
                    'https://www.trimarc.org/images/milestone/CCTV_06_275_0089.jpg',
                    'https://www.trimarc.org/images/milestone/CCTV_06_75_1908.jpg?date=1766935020000',
                    'https://www.trimarc.org/images/milestone/CCTV_06_75_1847.jpg?date=1766935262000',
                    'https://itscameras.dot.state.oh.us/images/artimis/CCTV4002.jpg?date=1766935262000'
                ],
                intervalMs: 120000,
                currentIndex: 0
            }
        ];

        let contentData = [
            { "url": "https://radar.weather.gov/ridge/standard/CONUS-LARGE_loop.gif", "title": "CONUS Radar (Large)" },
            { "url": "https://graphical.weather.gov/images/conus/T1_conus.png", "title": "CONUS Temperature" },
            { "url": "https://meshmap.net/", "title": "MeshMap" },
            { "url": "https://www.heavens-above.com/orbitdisplay.aspx?icon=iss&width=600&height=300&mode=M&satid=25544", "title": "ISS Tracker" },
            { "url": "https://prop.kc2g.com/renders/current/mufd-normal-now.svg", "title": "MUF Day Normal" },
            { "url": "https://www.wpc.ncep.noaa.gov/noaa/noaad2.gif?1766870046", "title": "Forecast Charts" },
            { "url": "https://services.swpc.noaa.gov/experimental/images/aurora_dashboard/tonights_static_viewline_forecast.png", "title": "Aurora Forecast" },
            { "url": "https://images.lightningmaps.org/blitzortung/america/index.php?animation=usa", "title": "USA Lightning Map" },
            { "url": "https://www.trimarc.org/images/milestone/CCTV_06_275_0089.jpg", "title": "Traffic Cam" },
            { "url": "https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/can/13/GOES16-CAN-13-1125x560.gif", "title": "CONUS IR Satellite" },
            { "url": "https://www.timeanddate.com/scripts/sunmap.php?iso=now", "title": "Sun/Darkness Map" },
            { "url": "https://www.hamqsl.com/solar101vhfpic.php", "title": "Solar Data" }
        ];

        let menuData = [
            { url: 'https://hamstudy.org/', title: 'HamStudy.org' },
            { url: 'contacts.html', title: 'GMRS Contacts' },
            { url: 'NetRadioLog.html', title: 'NetRadio Log' },
            { url: 'frequencies.html', title: 'GMRS Frequencies' },
            { url: 'https://www.weather.gov/', title: 'NWS Home' },
            { url: 'https://www.broadcastify.com/listen/', title: 'Broadcastify' },
            { url: 'https://ohgo.com/cincinnati?lt=39.17072157631222&ln=-84.47758421160262&z=10&ls=incident,dangerous-slowdown,construction,camera', title: 'OHGO Cameras' },
            { url: 'https://cincygmrs.com/', title: 'CincyGMRS Blog' },
            { url: 'https://cincinnatigmrs.ddns.net/', title: 'CincyGMRS Forum' },
            { url: 'https://mygmrs.com/', title: 'MyGMRS' },
            { url: 'https://www.qrz.com/', title: 'QRZ.com' },
            { url: 'http://websdr.org/', title: 'WebSDR' },
            { url: 'https://www.radioreference.com/db/browse/stid/21', title: 'RadioReference KY' }
        ];

        function getContentType(url){
            const u = url.toLowerCase();
            if (u.endsWith('.mp4')) return 'video';
            if (u.includes('hamqsl') || u.includes('solarpic') || u.includes('solarvhf') || u.includes('orbitdisplay') || u.includes('sunmap') || u.includes('lightningmaps')) return 'img';
            if (u.includes('meshmap.net')) return 'embed';
            if (u.match(/\.(jpg|jpeg|png|gif|svg|bmp)(\?.*)?$/)) return 'img';
            return 'link';
        }

        function buildGrid(){
            const grid = document.getElementById('grid-container'); grid.innerHTML = '';
            contentData.forEach((item, index) => {
                const gi = document.createElement('div'); gi.className = 'grid-item';
                gi.id = `tile-${index}`;
                const c = document.createElement('div'); c.className = 'image-container';
                const type = getContentType(item.url);
                let el;
                if(type === 'video'){
                    el = document.createElement('video'); el.src = item.url; el.autoplay = true; el.loop = true; el.muted = true;
                } else if (type === 'embed'){
                    el = document.createElement('iframe'); el.style.cssText = 'width:100%;height:100%;border:0'; el.src = item.url;
                } else if (type === 'link'){
                    el = document.createElement('div'); el.className = 'link-placeholder'; el.textContent = item.title || 'Open Link';
                } else {
                    el = document.createElement('img'); 
                    el.src = item.url + (item.url.includes('?')? '&':'?') + 't=' + Date.now();
                    if(item.url.includes('hamqsl')||item.url.includes('orbitdisplay')) el.classList.add('contain-fit');
                }
                c.appendChild(el);

                gi.onclick = ()=> {
                    if(index === 8) {
                        openCameraGrid();
                    } else {
                        (type === 'link' || type === 'embed') ? window.open(item.url, '_blank') : openLightbox(item.url, type);
                    }
                };

                if(item.title){ const t=document.createElement('span'); t.className='image-title'; t.innerText = item.title; c.appendChild(t); }
                gi.appendChild(c);
                grid.appendChild(gi);
            });
        }

        function openCameraGrid() {
            const lb = document.getElementById('lightbox');
            const grid = document.getElementById('lightbox-cam-grid');
            const img = document.getElementById('lightbox-img');
            const vid = document.getElementById('lightbox-video');
            const sett = document.getElementById('lightbox-settings');
            
            img.style.display='none'; vid.style.display='none'; sett.style.display='none';
            grid.innerHTML = '';
            grid.style.display = 'grid';
            lb.style.display='flex';

            cameraRotations[0].urls.forEach(url => {
                const div = document.createElement('div');
                div.className = 'cam-grid-item';
                const camImg = document.createElement('img');
                camImg.src = url + (url.includes('?')? '&':'?') + 't=' + Date.now();
                div.appendChild(camImg);
                grid.appendChild(div);
            });
        }

        function startCameraRotations(){
            cameraRotationIntervals.forEach(id=>clearInterval(id));
            cameraRotationIntervals = [];
            cameraRotations.forEach((rot)=>{
                const id = setInterval(()=>{
                    rot.currentIndex = (rot.currentIndex + 1) % rot.urls.length;
                    const newUrl = rot.urls[rot.currentIndex];
                    const tile = document.getElementById(`tile-${rot.tileIndex}`);
                    if(tile){
                        const img = tile.querySelector('img');
                        if(img) img.src = newUrl + (newUrl.includes('?')? '&':'?') + 't=' + Date.now();
                    }
                }, rot.intervalMs);
                cameraRotationIntervals.push(id);
            });
        }

        function renderMenu(){
            const container = document.getElementById('dropdown-content'); container.innerHTML = '';
            menuData.forEach(item=>{
                const a = document.createElement('a'); a.href = item.url; a.target = '_blank'; a.innerText = item.title; container.appendChild(a);
            });
            
            // Administrative Links
            container.innerHTML += `<hr style="border: 0; border-top: 1px solid #444; margin: 5px 0;">`;
            container.innerHTML += `<a href="javascript:location.reload()">Refresh Dashboard</a>`;
            container.innerHTML += `<a href="javascript:void(0)" onclick="openSettings()">Settings</a>`;

            // Menu Logout Link
            const logoutLink = document.createElement('a');
            logoutLink.href = "javascript:void(0)";
            logoutLink.style.color = "#ff4d4d";
            logoutLink.innerHTML = "üîå <b>Log Off Station</b>";
            logoutLink.onclick = (e) => {
                e.preventDefault();
                logout();
            };
            container.appendChild(logoutLink);
        }

        function openLightbox(url, type){
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            const vid = document.getElementById('lightbox-video');
            const grid = document.getElementById('lightbox-cam-grid');
            const sett = document.getElementById('lightbox-settings');
            img.style.display='none'; vid.style.display='none'; grid.style.display='none'; sett.style.display='none';
            lb.style.display='flex';
            if(type==='video'){ vid.src=url; vid.style.display='block'; vid.play(); } 
            else { img.src = url + (url.includes('?')? '&':'?') + 't=' + Date.now(); img.style.display='block'; }
        }

        function closeLightbox(){
            document.getElementById('lightbox').style.display='none';
            const vid = document.getElementById('lightbox-video'); if(vid) vid.pause();
            document.getElementById('lightbox-settings').style.display = 'none';
            document.getElementById('lightbox-cam-grid').style.display = 'none';
        }

        async function updateWeatherAlerts() {
            try {
                const response = await fetch(`https://api.weather.gov/alerts/active?point=${LATITUDE},${LONGITUDE}`);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const alertList = data.features.map(f => f.properties.headline).join(' | ');
                    alertsText = ` | ‚ö†Ô∏è ALERTS: ${alertList}`;
                } else {
                    alertsText = ' | [ Alerts: All Clear ]';
                }
            } catch (e) { alertsText = ' | Weather Alerts Unavailable'; }
        }

        async function fetchRSS() {
            let combinedHeadlines = "";
            for (let url of rssUrls) {
                try {
                    const res = await fetch(`https.api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if(data.items) combinedHeadlines += data.items.map(item => item.title).join(' ‚Ä¢ ') + " | ";
                } catch(e) { console.error("RSS fetch failed", e); }
            }
            return combinedHeadlines;
        }

        async function updateTicker(){
            try{
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&current=temperature_2m,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FNew_York`);
                const d = await r.json();
                const cur = d.current||{};
                const rssFeed = await fetchRSS();
                document.getElementById('ticker-inner').innerText = `[Cincinnati/NKY] ${new Date().toLocaleTimeString()} | ${Math.round(cur.temperature_2m||0)}¬∞F | Wind: ${Math.round(cur.wind_speed_10m||0)} mph` + alertsText + (rssFeed ? ` | RSS: ${rssFeed}` : '');
            }catch(e){ document.getElementById('ticker-inner').innerText = 'Data Unavailable'; }
        }

        function openSettings(){
            const panel = document.getElementById('lightbox-settings');
            const img = document.getElementById('lightbox-img');
            const vid = document.getElementById('lightbox-video');
            const grid = document.getElementById('lightbox-cam-grid');
            
            img.style.display='none'; vid.style.display='none'; grid.style.display='none';
            
            panel.innerHTML = `
                <h2>Dashboard Settings</h2>
                <div class="settings-row">
                    <label>Lat:</label><input type="number" step="0.01" id="set-lat" value="${LATITUDE}">
                    <label>Lon:</label><input type="number" step="0.01" id="set-lon" value="${LONGITUDE}">
                </div>
                
                <h3>Camera Rotation (Tile 8)</h3>
                <div id="camera-rotation-list"></div>
                <button onclick="addRow('camera-rotation-list')">+ Add Camera</button>
                
                <h3>Grid Tiles</h3>
                <div id="tile-editor" style="max-height:200px; overflow:auto"></div>
                <button onclick="addRow('tile-editor')">+ Add Tile</button>

                <h3>Menu Links</h3>
                <div id="menu-editor" style="max-height:200px; overflow:auto"></div>
                <button onclick="addRow('menu-editor')">+ Add Menu Link</button>

                <h3>Ticker RSS Feeds</h3>
                <div id="rss-editor" style="max-height:150px; overflow:auto"></div>
                <button onclick="addRow('rss-editor')">+ Add RSS Feed</button>
                
                <div style="margin-top:20px;">
                    <button onclick="saveSettings()">Save & Reload</button>
                    <button onclick="closeLightbox()">Cancel</button>
                    <button style="background:#822" onclick="if(confirm('Reset to defaults?')) {localStorage.removeItem('mhd_settings'); location.reload();}">Factory Reset</button>
                </div>
            `;

            cameraRotations[0].urls.forEach((url) => {
                const r = document.createElement('div'); r.className='settings-row';
                r.innerHTML = `<input type="text" value="${url}" style="flex:1" class="cam-url"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
                panel.querySelector('#camera-rotation-list').appendChild(r);
            });

            contentData.forEach(t => {
                const r = document.createElement('div'); r.className='settings-row';
                r.innerHTML = `<input type="text" value="${t.title}" style="width:150px" class="tile-title"><input type="text" value="${t.url}" style="flex:1" class="tile-url"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
                panel.querySelector('#tile-editor').appendChild(r);
            });

            menuData.forEach(m => {
                const r = document.createElement('div'); r.className='settings-row';
                r.innerHTML = `<input type="text" value="${m.title}" style="width:150px" class="menu-title"><input type="text" value="${m.url}" style="flex:1" class="menu-url"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
                panel.querySelector('#menu-editor').appendChild(r);
            });

            rssUrls.forEach(url => {
                const r = document.createElement('div'); r.className='settings-row';
                r.innerHTML = `<input type="text" value="${url}" style="flex:1" class="rss-url-input"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
                panel.querySelector('#rss-editor').appendChild(r);
            });

            document.getElementById('lightbox').style.display='flex';
            panel.style.display='block';
        }

        function addRow(targetId) {
            const r = document.createElement('div'); r.className='settings-row';
            if (targetId === 'rss-editor') {
                r.innerHTML = `<input type="text" placeholder="RSS URL" style="flex:1" class="rss-url-input"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
            } else if (targetId === 'camera-rotation-list') {
                r.innerHTML = `<input type="text" placeholder="Camera URL" style="flex:1" class="cam-url"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
            } else {
                const prefix = targetId === 'menu-editor' ? 'menu' : 'tile';
                r.innerHTML = `<input type="text" placeholder="Title" style="width:150px" class="${prefix}-title"><input type="text" placeholder="URL" style="flex:1" class="${prefix}-url"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
            }
            document.getElementById(targetId).appendChild(r);
        }

        function saveSettings(){
            LATITUDE = parseFloat(document.getElementById('set-lat').value);
            LONGITUDE = parseFloat(document.getElementById('set-lon').value);
            cameraRotations[0].urls = Array.from(document.querySelectorAll('.cam-url')).map(i => i.value).filter(v => v);
            contentData = Array.from(document.getElementById('tile-editor').children).map(row => ({
                title: row.querySelector('.tile-title').value,
                url: row.querySelector('.tile-url').value
            })).filter(t => t.url);
            menuData = Array.from(document.getElementById('menu-editor').children).map(row => ({
                title: row.querySelector('.menu-title').value,
                url: row.querySelector('.menu-url').value
            })).filter(m => m.url);
            rssUrls = Array.from(document.querySelectorAll('.rss-url-input')).map(i => i.value).filter(v => v);
            
            localStorage.setItem('mhd_settings', JSON.stringify({ latitude: LATITUDE, longitude: LONGITUDE, contentData, menuData, cameraRotations, rssUrls }));
            location.reload();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const s = JSON.parse(localStorage.getItem('mhd_settings'));
            if(s){ 
                LATITUDE=s.latitude; LONGITUDE=s.longitude; 
                contentData=s.contentData || contentData; 
                menuData=s.menuData || menuData;
                cameraRotations = s.cameraRotations || cameraRotations;
                rssUrls = s.rssUrls || rssUrls;
            }
            buildGrid(); renderMenu(); startCameraRotations();
            await updateWeatherAlerts();
            await updateTicker();
            setInterval(updateWeatherAlerts, 300000);
            setInterval(updateTicker, 60000);
        });
    </script>
</body>
</html>
