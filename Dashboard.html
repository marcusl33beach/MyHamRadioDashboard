<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>MyHamDashboard: Kentucky Focused</title>
    <style>
        /* GLOBAL RESET */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; 
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a; 
            color: #f0f0f0;
        }

        #page-container {
            display: flex;
            flex-direction: column;
            height: 100vh; 
            position: relative;
        }

        /* GRID LAYOUT (4x3) */
        #grid-container {
            flex-grow: 1; 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            overflow: hidden; 
        }

        .grid-item {
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-sizing: border-box; 
            background-color: #000;
            overflow: hidden; 
            position: relative;
            cursor: pointer; 
            transition: transform 0.1s;
        }

        .grid-item:hover {
            transform: scale(1.02);
            z-index: 5;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* CONTENT STYLING */
        .grid-item img, 
        .grid-item video { 
            width: 100%;
            height: 100%;
            display: block;
            border: none;
            object-fit: cover; 
        }

        /* SPECIAL CLASS: ZOOMS OUT to show the whole image */
        .grid-item img.contain-fit { 
            object-fit: contain; 
            background-color: #000; 
        }

        /* Image Title Styling */
        .image-title {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
            z-index: 1;
        }

        /* TICKER & MENU STYLES (Restored to working dropdown) */
        #ticker-wrap {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px; 
            background-color: rgba(0, 0, 0, 0.75); 
            border-top: 1px solid #555;
            overflow: visible; 
            white-space: nowrap;
            z-index: 9999; 
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #ticker-title {
            background-color: rgba(0, 0, 0, 0.75); 
            color: white;
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 0.85em; 
            z-index: 10;
            border-right: 1px solid #555; 
            cursor: pointer; 
            position: relative; 
            transition: background-color 0.3s;
        }

        #ticker-title:hover {
            background-color: #333; 
        }

        /* Dropdown Menu */
        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 30px; 
            left: 0;
            background-color: rgba(0, 0, 0, 0.9);
            min-width: 200px;
            box-shadow: 0px -4px 16px rgba(0,0,0,0.5);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
            border-bottom: none;
            backdrop-filter: blur(5px);
        }

        .dropdown-content a {
            color: #f0f0f0;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.9em;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }

        .dropdown-content a:hover { background-color: #b00; }

        #ticker-title:hover .dropdown-content { display: block; }

        /* Scrolling Text */
        #ticker-move {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-left 30s linear infinite;
            color: #fff;
            font-size: 0.95em; 
            font-weight: 500;
            line-height: 30px; 
        }

        @keyframes scroll-left {
            0%  { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* LIGHTBOX STYLES */
        #lightbox {
            display: none; 
            position: fixed;
            z-index: 10000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95); 
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .lightbox-content-style {
            max-width: 95%;
            max-height: 95%;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            border: 2px solid #333;
            object-fit: contain; 
        }

        #lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
        }

        #lightbox-close:hover { color: #b00; }

        /* GEMINI MODAL STYLES */
        #gemini-button {
            position: fixed;
            right: 20px;
            bottom: 45px;
            z-index: 999;
            padding: 10px 15px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s, transform 0.1s;
        }

        #gemini-button:hover {
            background-color: #303f9f;
            transform: scale(1.05);
        }
        
        #gemini-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(80vw, 600px);
            max-height: 80vh;
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            z-index: 10002;
            padding: 20px;
            overflow-y: auto;
        }

        #gemini-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: white; }
    </style>
</head>
<body>

    <div id="page-container">
        <main id="grid-container"></main>
        
        <button id="gemini-button" onclick="showGeminiModal()">
            ✨ Propagation Analyst
        </button>

        <div id="ticker-wrap">
            <div id="ticker-title">
                Menu &#9650; 
                <div class="dropdown-content">
                    <a href="https://hamstudy.org/" target="_blank">HamStudy.org</a>
                    <a href="https://www.weather.gov/" target="_blank">NWS Home</a>
                    <a href="https://mygmrs.com/" target="_blank">MyGMRS</a>
                    <a href="https://www.qrz.com/" target="_blank">QRZ.com</a>
                    <a href="http://websdr.org/" target="_blank">WebSDR</a> 
                    <a href="https://www.radioreference.com/db/browse/stid/21" target="_blank">RadioReference KY</a>
                    <a href="javascript:location.reload()">Refresh Dashboard</a>
                </div>
            </div>
            <div id="ticker-move" id="ticker-content">Loading Weather Data...</div>
        </div>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <span id="lightbox-close">&times;</span>
        <img id="lightbox-img" class="lightbox-content-style" style="display:none;">
        <video id="lightbox-video" class="lightbox-content-style" style="display:none;" controls autoplay loop></video>
    </div>

    <div id="gemini-modal">
        <div id="gemini-modal-header">
            <h3 style="margin:0; color: white;">✨ Current Propagation Analysis</h3>
            <span class="close-btn" onclick="closeGeminiModal()">&times;</span>
        </div>
        <div id="gemini-modal-content" style="color:#ddd;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = ""; // PASTE YOUR GEMINI API KEY HERE
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // Boone County, KY Coordinates
        const LATITUDE = 38.98;
        const LONGITUDE = -84.77; 
        
        // Image Refresh Rate (2 Minutes)
        const IMAGE_REFRESH_RATE_MS = 120000; 
        // Alerts refresh (5 minutes)
        const ALERTS_REFRESH_MS = 300000;

        // Alerts text appended to ticker (kept short)
        let alertsText = '';

        // --- VERIFIED KENTUCKY-FOCUSED CONTENT DATA (FIXED FOR STABILITY) ---
        const contentData = [
            // Row 1: Weather (Kentucky/Ohio Valley Focus - FIXED LINKS)
            // 1. FIXED: Using stable 'lite' version of Wilmington, OH Radar loop.
            { url: 'https://radar.weather.gov/lite/OHX_loop.gif', title: 'Local NWS Radar (OHX)' }, 
            // 2. FIXED: Using day-specific WPC temp forecast for stability.
            { url: 'https://www.wpc.ncep.noaa.gov/basicwx/temp/ohiov_max_min_day1.gif', title: 'Ohio Valley Max/Min Temp' }, 
            // 3. FIXED: Reverting to highly stable CONUS IR Satellite (high res local is too volatile).
            { url: 'https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/conus/13/latest.jpg', title: 'CONUS IR Satellite' }, 
            // 4. FIXED: Using explicit filename for the Categorical Outlook.
            { url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_cat.gif', title: 'SPC Severe Risk' }, 

            // Row 2: Propagation & Solar (Global/Continental - Already stable)
            { url: 'https://services.swpc.noaa.gov/images/animations/d-rap/global/d-rap/latest.png', title: 'D-Region Absorption' }, 
            { url: 'https://www.hamqsl.com/solarpic.php', title: 'Solar Data (N0NBH)' }, 
            { url: 'https://www.hamqsl.com/solarvhf.php', title: 'VHF Conditions' }, 
            { url: 'https://services.swpc.noaa.gov/experimental/images/aurora_dashboard/tonights_static_viewline_forecast.png', title: 'Aurora Forecast' }, 

            // Row 3: Utility (Unchanged/Local)
            { url: 'https://images.lightningmaps.org/blitzortung/america/index.php?animation=usa', title: 'USA Lightning Map' }, 
            { url: 'https://www.trimarc.org/images/milestone/CCTV_06_275_0089.jpg', title: 'Louisville Traffic Cam' }, 
            { url: 'https://www.timeanddate.com/scripts/sunmap.php?iso=now', title: 'Sun/Darkness Map' }, 
            { url: 'https://www.heavens-above.com/orbitdisplay.aspx?icon=iss&width=600&height=300&mode=M&satid=25544', title: 'ISS Tracker' } 
        ];

        /* 1. GRID BUILDER */
        function getContentType(url) {
            const lowerUrl = url.toLowerCase();
            if (lowerUrl.endsWith('.mp4')) return 'video';
            if (lowerUrl.includes('solarpic') || lowerUrl.includes('solarvhf')) return 'img';
            if (lowerUrl.includes('sunmap') || lowerUrl.includes('orbitdisplay') || lowerUrl.endsWith('.svg')) return 'img';
            if (lowerUrl.includes('lightningmaps')) return 'img';
            return 'img'; 
        }

        function buildGrid() {
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            
            contentData.forEach(item => {
                const url = item.url;
                const contentType = getContentType(url);

                const gridItem = document.createElement('div');
                gridItem.classList.add('grid-item');
                
                const imageContainer = document.createElement('div');
                imageContainer.classList.add('image-container');

                gridItem.onclick = function() { openLightbox(url, contentType); };

                let el;
                if (contentType === 'video') {
                    el = document.createElement('video');
                    el.src = url;
                    el.autoplay = true; el.loop = true; el.muted = true; el.controls = false;
                } else {
                    el = document.createElement('img');
                    el.setAttribute('data-base-src', url);
                    
                    // Add timestamp to force load
                    el.src = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                    el.referrerPolicy = "no-referrer";
                    
                    // Add contain-fit to specific banners
                    if(url.includes('hamqsl') || url.includes('orbitdisplay') || url.includes('grayline') || url.includes('wpc.ncep.noaa.gov') || url.includes('spc.noaa.gov')) {
                        el.classList.add('contain-fit');
                    }
                    el.onerror = function() { 
                        this.style.display='none';
                        this.parentElement.innerHTML += '<div style="color:#666; display:flex; justify-content:center; align-items:center; height:100%;">Image Unavailable</div>';
                    }; 
                }
                
                imageContainer.appendChild(el);
                if (item.title) {
                    const titleSpan = document.createElement('span');
                    titleSpan.classList.add('image-title');
                    titleSpan.innerText = item.title;
                    imageContainer.appendChild(titleSpan);
                }
                gridItem.appendChild(imageContainer);
                gridContainer.appendChild(gridItem);
            });
        }

        /* 2. IMAGE REFRESHER */
        function refreshImages() {
            document.querySelectorAll('#grid-container img').forEach(img => {
                const url = img.getAttribute('data-base-src');
                if (url) {
                    img.src = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                }
            });
        }

        /* 3. LIGHTBOX */
        function openLightbox(url, type) {
            const lightbox = document.getElementById('lightbox');
            const imgEl = document.getElementById('lightbox-img');
            const videoEl = document.getElementById('lightbox-video');

            imgEl.style.display = 'none'; videoEl.style.display = 'none'; videoEl.pause();

            if (type === 'video') {
                videoEl.src = url; videoEl.style.display = 'block'; videoEl.play();
            } else {
                imgEl.src = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                imgEl.style.display = 'block';
            }
            lightbox.style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            document.getElementById('lightbox-video').pause();
        }

        /* 4. WEATHER TICKER (NWS) */
        const WMO_CODES = {
            0:"Clear", 1:"Mainly Clear", 2:"Partly Cloudy", 3:"Overcast", 45:"Fog", 48:"Rime Fog",
            51:"Light Drizzle", 53:"Mod Drizzle", 55:"Dense Drizzle", 61:"Light Rain", 63:"Mod Rain", 65:"Heavy Rain",
            71:"Light Snow", 73:"Mod Snow", 75:"Heavy Snow", 80:"Light Showers", 81:"Mod Showers", 82:"Violent Showers",
            95:"Thunderstorm", 96:"Thunderstorm+Hail", 99:"Heavy T-Storm+Hail"
        };
        const WEATHER_API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&current=temperature_2m,weather_code,wind_speed_10m&hourly=precipitation_probability&forecast_hours=1&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FNew_York`;

        // Fetch active NWS alerts for the point; fallback to local /proxy if direct fetch fails
        async function updateAlerts() {
            const alertsUrl = `https://api.weather.gov/alerts/active?point=${LATITUDE},${LONGITUDE}`;
            const titleEl = document.getElementById('ticker-title');
            try {
                const resp = await fetch(alertsUrl, { headers: { 'Accept': 'application/geo+json' } });
                if (!resp.ok) throw new Error('NWS fetch failed');
                const data = await resp.json();
                const alerts = data.features || [];
                if (alerts.length === 0) {
                    alertsText = '';
                    titleEl.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
                    return;
                }
                const parts = alerts.slice(0,2).map(a => {
                    const p = a.properties || {};
                    const ev = p.event || 'Alert';
                    const sev = p.severity || '';
                    const area = (p.areaDesc || '').replace(/\s+/g, ' ');
                    const onset = p.effective ? new Date(p.effective).toLocaleTimeString() : '';
                    const ends = p.ends ? new Date(p.ends).toLocaleTimeString() : '';
                    return `${ev}${sev ? ' ('+sev+')' : ''} ${area}${onset ? ' @'+onset : ''}${ends ? '→'+ends : ''}`.trim();
                });
                alertsText = ' | ALERTS: ' + parts.join(' || ');
                titleEl.style.backgroundColor = '#b00';
            } catch (e) {
                // Try proxy fallback if available
                try {
                    const proxyUrl = '/proxy?url=' + encodeURIComponent(alertsUrl);
                    const resp2 = await fetch(proxyUrl);
                    if (!resp2.ok) throw new Error('Proxy fetch failed');
                    const data2 = await resp2.json();
                    const alerts = data2.features || [];
                    if (alerts.length === 0) {
                        alertsText = '';
                        titleEl.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
                        return;
                    }
                    const parts = alerts.slice(0,2).map(a => {
                        const p = a.properties || {};
                        const ev = p.event || 'Alert';
                        const sev = p.severity || '';
                        const area = (p.areaDesc || '').replace(/\s+/g, ' ');
                        const onset = p.effective ? new Date(p.effective).toLocaleTimeString() : '';
                        const ends = p.ends ? new Date(p.ends).toLocaleTimeString() : '';
                        return `${ev}${sev ? ' ('+sev+')' : ''} ${area}${onset ? ' @'+onset : ''}${ends ? '→'+ends : ''}`.trim();
                    });
                    alertsText = ' | ALERTS: ' + parts.join(' || ');
                    titleEl.style.backgroundColor = '#b00';
                } catch (e2) {
                    alertsText = '';
                    titleEl.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
                }
            }
        }

        async function updateTicker() {
            const ticker = document.getElementById('ticker-move');
            try {
                const response = await fetch(WEATHER_API_URL);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                
                const cur = data.current;
                const desc = WMO_CODES[cur.weather_code] || "Unknown";
                const rain = data.hourly?.precipitation_probability?.[0] || 0;
                ticker.innerText = `[Boone County, KY] ${new Date().toLocaleTimeString()} | Temp: ${Math.round(cur.temperature_2m)}°F | Wind: ${Math.round(cur.wind_speed_10m)} mph | ${desc} | Rain: ${rain}%` + alertsText;
            } catch (error) {
                ticker.innerText = "Weather Data Unavailable (Check Network)";
            }
        }

        /* 5. GEMINI ANALYST */
        function showGeminiModal() {
            document.getElementById('gemini-modal').style.display = 'block';
            document.getElementById('gemini-modal-content').innerHTML = '<h3 style="text-align:center; color:#ff9800;">Analyzing...</h3>';
            callGeminiPropagationAnalysis();
        }
        function closeGeminiModal() { document.getElementById('gemini-modal').style.display = 'none'; }

        async function callGeminiPropagationAnalysis(retry=0) {
            const prompt = `Act as an expert amateur radio tactical propagation analyst. Summarize current solar/geomagnetic conditions (SFI, K-Index) and provide band recommendations for Northern Kentucky, using Boone County, KY as the reference point.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], config: { tools: [{ "google_search": {} }] } };
            
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (!response.ok && retry < 3) return setTimeout(() => callGeminiPropagationAnalysis(retry+1), 2000);
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis available. Please ensure your API key is valid.";
                
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                document.getElementById('gemini-modal-content').innerHTML = html;
            } catch (e) {
                document.getElementById('gemini-modal-content').innerHTML = "Error communicating with the Gemini API. Check your network or API Key.";
            }
        }

        /* INIT */
        document.addEventListener('DOMContentLoaded', () => {
            buildGrid();
            refreshImages();
            setInterval(refreshImages, IMAGE_REFRESH_RATE_MS);
            updateTicker();
            setInterval(updateTicker, 900000);

            // Alerts: update immediately and periodically
            updateAlerts();
            setInterval(updateAlerts, ALERTS_REFRESH_MS);
        });
    </script>
</body>
</html>