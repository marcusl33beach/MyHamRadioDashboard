<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>MyHamDashboard</title>
    <style>
        /* GLOBAL RESET */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        /* Reserve space for bottom ticker */
        #page-container { display:flex; flex-direction:column; min-height:100vh; }

        /* GRID LAYOUT (4x3) */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            gap: 6px;
            padding: 6px;
            box-sizing: border-box;
            width: 100%;
            height: calc(100vh - 34px); /* leave room for ticker */
            overflow: hidden;
            min-height: 0;
        }

        .grid-item { position: relative; background:#000; border:1px solid rgba(255,255,255,0.08); overflow:hidden; min-height:0 }
        .image-container { width:100%; height:100%; display:block; min-height:0 }
        .grid-item img, .grid-item video { width:100%; height:100%; object-fit:cover; display:block }
        .grid-item img.contain-fit { object-fit:contain; background:#000 }

        .image-title { position:absolute; top:0; left:0; width:100%; background:rgba(0,0,0,0.5); padding:6px 10px; font-weight:700; z-index:2 }
        .link-placeholder { display:flex; align-items:center; justify-content:center; width:100%; height:100%; color:#ddd; background:linear-gradient(180deg,#111,#000); font-weight:700 }

        /* TICKER */
        #ticker-wrap { position:fixed; left:0; right:0; bottom:0; height:34px; background:rgba(0,0,0,0.8); border-top:1px solid #444; display:flex; align-items:center; z-index:9999 }
        #ticker-title { padding:0 12px; background:rgba(0,0,0,0.7); color:#fff; height:34px; line-height:34px; display:flex; align-items:center; border-right:1px solid #444; position:relative; flex:0 0 auto }
        /* Dropdown Menu */
        .dropdown-content { display:none; position:absolute; bottom:34px; left:0; background-color:rgba(0,0,0,0.95); min-width:200px; box-shadow:0px -4px 16px rgba(0,0,0,0.5); border:1px solid #444; border-bottom:none; z-index:10000 }
        .dropdown-content a { color:#f0f0f0; padding:8px 12px; display:block; text-decoration:none; font-size:0.9em }
        .dropdown-content a:hover { background:rgb(78, 77, 77) }
        #ticker-title:hover .dropdown-content { display:block }
        /* Scrolling feed constrained to remaining space */
        #ticker-move { flex:1 1 auto; overflow:hidden; height:100%; display:flex; align-items:center }
        #ticker-inner { display:inline-block; padding-left:100%; white-space:nowrap; animation:scroll-left 30s linear infinite; color:#fff; }
        @keyframes scroll-left { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }

        /* LIGHTBOX */
        #lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); align-items:center; justify-content:center; z-index:10000 }
        .lightbox-content-style { max-width:95%; max-height:95%; }
        #lightbox-close { position:absolute; top:18px; right:22px; font-size:34px; color:#fff; cursor:pointer }
    </style>
</head>
<body>
    <div id="page-container">
        <main id="grid-container"></main>

        <div id="ticker-wrap">
            <div id="ticker-title">▾ Menu
                <div class="dropdown-content">
                    <a href="https://hamstudy.org/" target="_blank">HamStudy.org</a>
                    <a href="https://www.weather.gov/" target="_blank">NWS Home</a>
                    <a href="https://ohgo.com/cincinnati?lt=39.17072157631222&ln=-84.47758421160262&z=10&ls=incident,dangerous-slowdown,construction,camera" target="_blank">Cameras</a>
                    <a href="https://mygmrs.com/" target="_blank">MyGMRS</a>
                    <a href="https://www.qrz.com/" target="_blank">QRZ.com</a>
                    <a href="http://websdr.org/" target="_blank">WebSDR</a>
                    <a href="https://www.radioreference.com/db/browse/stid/21" target="_blank">RadioReference KY</a>
                    <a href="javascript:location.reload()">Refresh Dashboard</a>
                </div>
            </div>
            <div id="ticker-move"><div id="ticker-inner">Loading Weather Data...</div></div>
        </div>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <div id="lightbox-close">&times;</div>
        <img id="lightbox-img" class="lightbox-content-style" style="display:none" />
        <video id="lightbox-video" class="lightbox-content-style" style="display:none" controls autoplay loop></video>
    </div>

    <script>
        // --- CONFIG ---
        const LATITUDE = 38.98;
        const LONGITUDE = -84.77;
        const IMAGE_REFRESH_RATE_MS = 600000; // 10 minutes
        const ALERTS_REFRESH_MS = 600000; // 10 minutes
        let alertsText = '';

                // Default contentData (used unless you override in Dashboard.html)
                const contentData = [
    { "url": "https://radar.weather.gov/ridge/standard/CONUS-LARGE_loop.gif", "title": "CONUS Radar (Large)" },
    { "url": "https://graphical.weather.gov/images/conus/T1_conus.png", "title": "CONUS Temperature" },
    { "url": "https://meshmap.net/", "title": "MeshMap" },
    { "url": "https://www.heavens-above.com/orbitdisplay.aspx?icon=iss&width=600&height=300&mode=M&satid=25544", "title": "ISS Tracker" },
    { "url": "https://prop.kc2g.com/renders/current/mufd-normal-now.svg", "title": "MUF Day Normal" },
    { "url": "https://www.wpc.ncep.noaa.gov/noaa/noaad2.gif?1766870046", "title": "Forecast Charts" },
    { "url": "https://services.swpc.noaa.gov/experimental/images/aurora_dashboard/tonights_static_viewline_forecast.png", "title": "Aurora Forecast" },
    { "url": "https://images.lightningmaps.org/blitzortung/america/index.php?animation=usa", "title": "USA Lightning Map" },
    { "url": "https://www.trimarc.org/images/milestone/CCTV_06_275_0089.jpg", "title": "Traffic Cam" },
    { "url": "https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/can/13/GOES16-CAN-13-1125x560.gif", "title": "CONUS IR Satellite" },
    { "url": "https://www.timeanddate.com/scripts/sunmap.php?iso=now", "title": "Sun/Darkness Map" },
    { "url": "https://www.hamqsl.com/solar101vhfpic.php", "title": "Solar Data" }
];

        /* GRID BUILDER */
        function getContentType(url){
            const u = url.toLowerCase();
            if (u.endsWith('.mp4')) return 'video';
            // Known hosts that return image content despite lacking an image extension
            if (u.includes('hamqsl') || u.includes('solarpic') || u.includes('solarvhf') || u.includes('orbitdisplay') || u.includes('sunmap') || u.includes('lightningmaps')) return 'img';
            // Try embedding meshmap in-tile; if framing blocked we'll show an Open link
            if (u.includes('meshmap.net')) return 'embed';
            if (u.match(/\.(jpg|jpeg|png|gif|svg|bmp)(\?.*)?$/)) return 'img';
            return 'link';
        }

        function buildGrid(){
            const grid = document.getElementById('grid-container'); grid.innerHTML = '';
            contentData.forEach(item => {
                const gi = document.createElement('div'); gi.className = 'grid-item';
                const c = document.createElement('div'); c.className = 'image-container';
                const type = getContentType(item.url);
                let el;
                if(type === 'video'){
                    el = document.createElement('video'); el.src = item.url; el.autoplay = true; el.loop = true; el.muted = true;
                } else if (type === 'embed'){
                    // Attempt to embed meshmap directly inside the tile via iframe
                    el = document.createElement('iframe');
                    el.style.cssText = 'width:100%;height:100%;border:0';
                    el.src = item.url;
                    // If embedding is blocked, replace the iframe with a link placeholder
                    const fallbackReplace = () => {
                        const placeholder = document.createElement('div'); placeholder.className='link-placeholder'; placeholder.textContent = item.title || 'Open Site';
                        placeholder.onclick = () => window.open(item.url, '_blank');
                        c.innerHTML = ''; c.appendChild(placeholder);
                        gi.onclick = null;
                    };
                    // If iframe load fails or doesn't render useful content within 2.5s, show open-in-new-tab placeholder
                    const timeout = setTimeout(()=>{
                        try{
                            // try to access contentDocument - will throw on cross-origin (assume OK)
                            if(!el.contentDocument || !el.contentDocument.body || el.contentDocument.body.childNodes.length===0){
                                fallbackReplace();
                            }
                        }catch(e){
                            // cross-origin access denied -> likely loaded fine, don't replace
                        }
                    }, 2500);
                    el.onload = ()=>{ clearTimeout(timeout); };
                } else if (type === 'link'){
                    el = document.createElement('div'); el.className = 'link-placeholder'; el.textContent = item.title || 'Open Link';
                } else {
                    el = document.createElement('img'); el.setAttribute('data-base-src', item.url); el.referrerPolicy = 'no-referrer';
                    if(item.url.includes('hamqsl')||item.url.includes('orbitdisplay')||item.url.includes('wpc.ncep.noaa.gov')||item.url.includes('spc.noaa.gov')||item.url.includes('lightningmaps')) el.classList.add('contain-fit');
                    el.src = item.url + (item.url.includes('?')? '&':'?') + 't=' + Date.now();
                    el.onerror = function(){ this.style.display='none'; if(!c.querySelector('.image-unavailable-msg')){ const d=document.createElement('div'); d.className='image-unavailable-msg'; d.style.cssText='color:#666;display:flex;align-items:center;justify-content:center;height:100%'; d.innerText='Image Unavailable'; c.appendChild(d); } }
                }
                c.appendChild(el);
                // Wire click handlers according to type
                if (type === 'embed'){
                    // clicking iframe tile should attempt focus/open nothing; provide an overlay click to open in new tab
                    gi.onclick = ()=>{ window.open(item.url, '_blank'); };
                } else if (type === 'link'){
                    gi.onclick = ()=>window.open(item.url, '_blank');
                } else {
                    gi.onclick = ()=>openLightbox(item.url, getContentType(item.url));
                }
                if(item.title){ const t=document.createElement('span'); t.className='image-title'; t.innerText = item.title; c.appendChild(t); }
                gi.appendChild(c);
                grid.appendChild(gi);
            });
        }

        function refreshImages(){ document.querySelectorAll('#grid-container img').forEach(img=>{ const u = img.getAttribute('data-base-src'); if(u) img.src = u + (u.includes('?')? '&':'?') + 't=' + Date.now(); }); }

        function openLightbox(url,type){
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            const vid = document.getElementById('lightbox-video');
            // remove any previously injected iframe
            const prev = document.getElementById('lightbox-injected-iframe');
            if(prev) prev.remove();

            img.style.display='none'; vid.style.display='none'; vid.pause();

            if(type==='video'){
                vid.src=url; vid.style.display='block'; vid.play();
                lb.style.display='flex';
                return;
            }

            if(type==='try-embed'){
                // attempt to embed in an iframe; if blocked, fall back to opening a new tab
                const iframe = document.createElement('iframe');
                iframe.id = 'lightbox-injected-iframe';
                iframe.style.cssText = 'border:0;width:90%;height:80%';
                iframe.src = url;
                iframe.onload = function(){ img.style.display='none'; vid.style.display='none'; iframe.style.display='block'; lb.style.display='flex'; };
                // fallback if iframe doesn't load within 2.5s (likely blocked)
                const fallback = setTimeout(()=>{
                    if(!iframe.contentDocument || iframe.contentDocument.location.href === 'about:blank'){
                        iframe.remove();
                        window.open(url, '_blank');
                    }
                }, 2500);
                iframe.onerror = function(){ clearTimeout(fallback); iframe.remove(); window.open(url, '_blank'); };
                // append and wait for onload or fallback
                lb.appendChild(iframe);
                return;
            }

            // default: show as image
            img.src = url + (url.includes('?')? '&':'?') + 't=' + Date.now(); img.style.display='block';
            lb.style.display='flex';
        }
        function closeLightbox(){ const lb = document.getElementById('lightbox'); lb.style.display='none'; const vid = document.getElementById('lightbox-video'); vid.pause(); const injected = document.getElementById('lightbox-injected-iframe'); if(injected) injected.remove(); }

        // WEATHER TICKER (open-meteo)
        const WMO_CODES = {0:"Clear",1:"Mainly Clear",2:"Partly Cloudy",3:"Overcast",45:"Fog",48:"Rime Fog",51:"Light Drizzle",61:"Light Rain",80:"Light Showers",95:"Thunderstorm"};
        const WEATHER_API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&current=temperature_2m,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FNew_York`;
        async function updateTicker(){
            const t = document.getElementById('ticker-inner');
            try{
                const r = await fetch(WEATHER_API_URL);
                if(!r.ok) throw 0;
                const d = await r.json();
                const cur = d.current||{};
                const desc = WMO_CODES[cur.weather_code]||'Unknown';
                t.innerText = `[Boone County, KY] ${new Date().toLocaleTimeString()} | ${Math.round(cur.temperature_2m||0)}°F | ${Math.round(cur.wind_speed_10m||0)} mph | ${desc}` + (alertsText||'');
            }catch(e){
                t.innerText = 'Weather Data Unavailable' + (alertsText||'');
            }
        }

        // Alerts (silent fail for file://)
        async function updateAlerts(){
            try{
                const resp = await fetch(`https://api.weather.gov/alerts/active?point=${LATITUDE},${LONGITUDE}`,{headers:{'Accept':'application/geo+json'}});
                if(!resp.ok) throw 0;
                const d = await resp.json();
                const alerts = d.features||[];
                if(!alerts.length){ alertsText=' | No Alerts'; return; }
                alertsText = ' | ALERTS: ' + alerts.slice(0,2).map(a=>a.properties?.event||'Alert').join(' || ');
            }catch(e){ alertsText=' | No Alerts'; }
        }

        /* INIT */
        document.addEventListener('DOMContentLoaded', async ()=>{
            buildGrid();
            refreshImages();
            setInterval(refreshImages, IMAGE_REFRESH_RATE_MS);
            // Await alerts so ticker includes alert text immediately
            await updateAlerts();
            updateTicker();
            setInterval(updateTicker, IMAGE_REFRESH_RATE_MS);
            setInterval(updateAlerts, ALERTS_REFRESH_MS);
        });
    </script>
</body>
</html>
